
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Query Archive Database, the Apathetic Way - DataChomp</title>
  <meta name="author" content="Rob Sullivan">

  
  <meta name="description" content="When talking to people about data archival strategies, a question that comes up regularly is ‘how do I even get the archived data?’ This is in part &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://datachomp.com/archives/query-archive-database">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="DataChomp" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1806527-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DataChomp</a></h1>
  
    <h2>Chomping At The Bits</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:datachomp.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="/books">Books</a></li>
  <li><a href="/speaking">Speaking/Travel</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Query Archive Database, the Apathetic Way</h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-08T23:23:54-05:00" pubdate data-updated="true">Jun 8<span>th</span>, 2015</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>When talking to people about data archival strategies, a question that comes up regularly is ‘how do I even get the archived data?’  This is in part because ~modern~ web frameworks like Rack-on-Rails do not always make multiple data sources a straight forward task. True to form, for every problem a web framework can create, postgres can usually fix it.</p>

<p>Say we have a main database &ndash; ‘burrito_store’ that holds the main transactions and an archive database ‘burrito_archive’ that holds stale records&hellip;ok, forget pretending, lets just get straight to code.</p>

<h4>Main Plumbing:</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE DATABASE burrito_store;
</span><span class='line'>CREATE DATABASE burrito_archive;
</span><span class='line'>
</span><span class='line'>\c burrito_store
</span><span class='line'>CREATE TABLE burrito_sales (id serial primary key, customer_id int, sale_amount int, created_at timestamp, updated_at timestamp)
</span><span class='line'>
</span><span class='line'>INSERT INTO burrito_sales(customer_id, sale_amount, created_at, updated_at)
</span><span class='line'>values(1, 123, now(), now()), (1, 123, now(), now()),(1, 123, now(), now())
</span><span class='line'>,(2, 123, now(), now()),(2, 123, now(), now()) ,(2, 123, now(), now())
</span><span class='line'>,(3, 123, now(), now()),(4, 123, now(), now())
</span><span class='line'>
</span><span class='line'>CREATE EXTENSION postgres_fdw;
</span><span class='line'>CREATE SERVER archive
</span><span class='line'> FOREIGN DATA WRAPPER postgres_fdw
</span><span class='line'>  OPTIONS (host 'localhost', port '5432', dbname 'burrito_archive');
</span><span class='line'>
</span><span class='line'>CREATE USER MAPPING FOR public SERVER archive OPTIONS (user 'rob');
</span><span class='line'>CREATE FOREIGN TABLE sales_archive (id int, customer_id integer, sale_amount int, created_at timestamp, updated_at timestamp)
</span><span class='line'> SERVER archive OPTIONS (schema_name 'public', table_name 'burrito_sales_archive');</span></code></pre></td></tr></table></div></figure>


<h4>On the archive database:</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE TABLE burrito_sales_archive (id int primary key, customer_id int, sale_amount int, created_at timestamp, updated_at timestamp)
</span><span class='line'>
</span><span class='line'>CREATE EXTENSION postgres_fdw;
</span><span class='line'>CREATE SERVER store
</span><span class='line'> FOREIGN DATA WRAPPER postgres_fdw
</span><span class='line'>  OPTIONS (host 'localhost', port '5432', dbname 'burrito_store');
</span><span class='line'>
</span><span class='line'>CREATE USER MAPPING FOR public SERVER store OPTIONS (user 'rob');
</span><span class='line'>CREATE FOREIGN TABLE sales (id int, customer_id integer, sale_amount int, created_at timestamp, updated_at timestamp)
</span><span class='line'> SERVER store OPTIONS (schema_name 'public', table_name 'burrito_sales');
</span><span class='line'>
</span><span class='line'>INSERT INTO burrito_sales_archive(id, customer_id, sale_amount, created_at, updated_at)
</span><span class='line'>SELECT id, customer_id, sale_amount, created_at, updated_at
</span><span class='line'>FROM sales order by id;</span></code></pre></td></tr></table></div></figure>


<p>At this point, we should be able to query and interact with the desired table from either database. Now, we can just create a basic view to make things easier for our poor application:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>CREATE VIEW total_sales as
</span><span class='line'>SELECT * from burrito_sales
</span><span class='line'>UNION
</span><span class='line'>SELECT * from sales_archive;
</span><span class='line'>
</span><span class='line'>EXPLAIN SELECT * FROM total_sales ;
</span><span class='line'>"HashAggregate  (cost=248.19..277.94 rows=2975 width=28)"
</span><span class='line'>"  Group Key: burrito_sales.id, burrito_sales.customer_id, burrito_sales.sale_amount, burrito_sales.created_at, burrito_sales.updated_at"
</span><span class='line'>"  -&gt;  Append  (cost=0.00..211.00 rows=2975 width=28)"
</span><span class='line'>"        -&gt;  Seq Scan on burrito_sales  (cost=0.00..24.00 rows=1400 width=28)"
</span><span class='line'>"        -&gt;  Foreign Scan on sales_archive  (cost=100.00..157.25 rows=1575 width=28)"</span></code></pre></td></tr></table></div></figure>


<p>Viola! It works! If you look at the cost of the foreign scan, you will see that this operation doesn’t come cheap or free. In this example, burrito_archive even lives on the same server, so you can imagine how performance amplifies as you get further from main datastore. That may or may not be important to you at this time and at a minimum, this strategy can at least get your Proof of Concept going while you check out gems like <a href="https://github.com/tchandy/octopus">Octopus</a> or <a href="http://stackoverflow.com/questions/28485137/multiple-database-connection-in-rails-4/28490913#28490913">additional decorators for your connection string/models</a>.</p>

<p>Note: This is just a real quick and dirty way of doing this with very low technical overhead. Yes, other options exist depending on a variety of factors.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Rob Sullivan</span></span>

      








  


<time datetime="2015-06-08T23:23:54-05:00" pubdate data-updated="true">Jun 8<span>th</span>, 2015</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://datachomp.com/archives/query-archive-database/" data-via="datachomp" data-counturl="http://datachomp.com/archives/query-archive-database/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/archives/carne-asada-hold-the-self-join/" title="Previous Post: Carne Asada hold the self join">&laquo; Carne Asada hold the self join</a>
      
      
        <a class="basic-alignment right" href="/archives/getting-postgres-version-with-golang/" title="Next Post: Getting Postgres Version with Golang">Getting Postgres Version with Golang &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
	<a href="/"><img src="http://static.datachomp.com/datachomp.png" width="236" height="236" alt="Data Eating Alligator" /></a><br/>
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archives/getting-postgres-version-with-golang/">Getting Postgres Version With Golang</a>
      </li>
    
      <li class="post">
        <a href="/archives/query-archive-database/">Query Archive Database, the Apathetic Way</a>
      </li>
    
      <li class="post">
        <a href="/archives/carne-asada-hold-the-self-join/">Carne Asada Hold the Self Join</a>
      </li>
    
      <li class="post">
        <a href="/archives/gaming-on-linux/">Gaming on Linux</a>
      </li>
    
      <li class="post">
        <a href="/archives/personal-twitter-tips-for-maximum-happiness/">Personal Twitter Tips for Maximum Happiness</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Rob Sullivan - Hand-crafted in OK <img src="http://static.datachomp.com/ok.gif" height="15" width="15" /> - 
  <span class="credit">Served by <a href="http://octopress.org">Octopress</a> and Github</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'datachomp';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://datachomp.com/archives/query-archive-database/';
        var disqus_url = 'http://datachomp.com/archives/query-archive-database/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>






<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100787394); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100787394ns.gif" /></p></noscript>
</body>
</html>
