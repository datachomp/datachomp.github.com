
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Getting Started With PGBouncer - DataChomp</title>
  <meta name="author" content="Rob Sullivan">

  
  <meta name="description" content="One of the issues we face at Raisemore is a continuous flux in our number of connections to our primary Postgres database. If our load increases and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://datachomp.com/archives/getting-started-with-pgbouncer">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="DataChomp" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1806527-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DataChomp</a></h1>
  
    <h2>Chomping At The Bits</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:datachomp.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="/books">Books</a></li>
  <li><a href="/speaking">Speaking/Travel</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Getting Started With PGBouncer</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-02T22:00:00-06:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>One of the issues we face at Raisemore is a continuous flux in our number of connections to our primary Postgres database. If our load increases and we have to spin up more front end servers or spin up more backend servers. This can quickly wreck our connection limit. One solution, is for me to babysit the connection size on the pg server itself&hellip; or perhaps I can give the Apps the middle finger and starve their connection limit &ndash; neither of these lead to happy outcomes for everyone involved.</p>

<h3>apt-get install happiness</h3>

<p>A better compromise is to just put a connection pooler like <a href="http://wiki.postgresql.org/wiki/PgBouncer">PgBouncer</a> in front of our postgres database. In the same way we proxy our applications with Nginx, we can apply the same concept to our database(s) with Pgbouncer. Let&rsquo;s get started:</p>

<pre><code>--Assuming your pg database is already up and running
--databasename = burrito_hq  username = elguapo
sudo apt-get install -y pgbouncer
sudo nano /etc/pgbouncer/userlist.txt
&gt; "postgres" "postgres"
&gt; "elguapo" "hefe"
sudo nano /etc/pgbouncer/pgbouncer.ini
&gt; [databases]
&gt; burrito_hq = host=localhost port=5432 dbname=burrito_hq user=elguapo password=hefe
&gt; [pgbouncer]
&gt; listen_addr = *
&gt; auth_type = md5
&gt; admin_users = postgres
&gt; stats_users = postgres
</code></pre>

<p>Above are some of the settings I changed to get started. As you get more familiar with Pgbouncer, change the <a href="http://pgbouncer.projects.pgfoundry.org/doc/config.html">various settings</a> as you see fit and for your workload.<br/>
Let&rsquo;s test our settings by firing up PgBouncer. PgBouncer is closely tied to the postgres user on the server, so we&rsquo;ll &lsquo;switch user&rsquo; into the postgres account to crank it up:</p>

<pre><code>sudo su postgres -c"pgbouncer -d /etc/pgbouncer/pgbouncer.ini"
</code></pre>

<p>On our client machine, lets attempt a connection to our server which has an ip of 172.16.150.128:</p>

<pre><code>psql -h 172.16.150.128 -p 6432 -U elguapo -d burrito_hq 
</code></pre>

<p>and hopefully we&rsquo;re in!  Once we know our settings are in good shape, lets turn PgBouncer auto start mode on:</p>

<pre><code>sudo nano /etc/default/pgbouncer
&gt; START=1
sudo reboot #reboot the box to test it out
</code></pre>

<p>When the server comes back online, hopefully you can connect again from the client. Now that the server is stable again, we can go get completely lost in the <a href="http://pgbouncer.projects.pgfoundry.org/doc/usage.html">documentation</a> and let the tool really shine.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Rob Sullivan</span></span>

      








  


<time datetime="2013-12-02T22:00:00-06:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2013</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="//twitter.com/share" class="twitter-share-button" data-url="http://datachomp.com/archives/getting-started-with-pgbouncer/" data-via="datachomp" data-counturl="http://datachomp.com/archives/getting-started-with-pgbouncer/" >Tweet</a>
  
  
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/archives/heroku-pg-extras-builds-bridges/" title="Previous Post: heroku pg-extras builds bridges">&laquo; heroku pg-extras builds bridges</a>
      
      
        <a class="basic-alignment right" href="/archives/the-appdevs-are-idiots/" title="Next Post: The AppDevs are idiots">The AppDevs are idiots &raquo;</a>
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
	<a href="/"><img src="http://static.datachomp.com/datachomp.png" width="236" height="236" alt="Data Eating Alligator" /></a><br/>
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archives/query-archive-database/">Query Archive Database, the Apathetic Way</a>
      </li>
    
      <li class="post">
        <a href="/archives/carne-asada-hold-the-self-join/">Carne Asada Hold the Self Join</a>
      </li>
    
      <li class="post">
        <a href="/archives/gaming-on-linux/">Gaming on Linux</a>
      </li>
    
      <li class="post">
        <a href="/archives/personal-twitter-tips-for-maximum-happiness/">Personal Twitter Tips for Maximum Happiness</a>
      </li>
    
      <li class="post">
        <a href="/archives/always-get-an-absentee-ballot/">Always Get an Absentee Ballot</a>
      </li>
    
  </ul>
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2015 - Rob Sullivan - Hand-crafted in OK <img src="http://static.datachomp.com/ok.gif" height="15" width="15" /> - 
  <span class="credit">Served by <a href="http://octopress.org">Octopress</a> and Github</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'datachomp';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://datachomp.com/archives/getting-started-with-pgbouncer/';
        var disqus_url = 'http://datachomp.com/archives/getting-started-with-pgbouncer/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>






<script src="//static.getclicky.com/js" type="text/javascript"></script>
<script type="text/javascript">try{ clicky.init(100787394); }catch(e){}</script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/100787394ns.gif" /></p></noscript>
</body>
</html>
