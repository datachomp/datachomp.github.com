
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>DataChomp</title>
  <meta name="author" content="Rob Sullivan">

  
  <meta name="description" content="If we get over the notion that all data is created equal, it opens up options for us.
For example, your DBA wants some sort of data consistency and &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://datachomp.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="DataChomp" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-1806527-13']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">DataChomp</a></h1>
  
    <h2>Chomping At The Bits</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:datachomp.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives/">Archives</a></li>
  <li><a href="/books">Books</a></li>
  <li><a href="/speaking">Speaking/Travel</a></li>
  <li><a href="/about">About</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/enums-for-when-you-just-cant-hande-another-foreign-key/">Enums for When You Just Cant Hande Another Foreign Key</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-29T10:11:00-06:00" pubdate data-updated="true">Jan 29<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>If we get over the notion that all data is created equal, it opens up options for us.
For example, your DBA wants some sort of data consistency and integrity&hellip; both very good things
but you are just making a quick little 1 off table that you don&rsquo;t want to sprawl to 4 or 5 tables with foreign keys.</p>

<h4>enum my heart</h4>

<p>For these situations, I like to just use <a href="http://www.postgresql.org/docs/current/static/datatype-enum.html">postgres enums</a>. Check it out:</p>

<pre><code>create type verdict as enum ('gross', 'can eat', 'amazing');

create table burritos (id serial not null primary key, title varchar(50), thoughts verdict not null);
insert into burritos (title, thoughts) values ('road kill burrito', 'yummy');

insert into burritos (title, thoughts) values ('road kill burrito', 'gross');
--Complete Failure

insert into burritos (title, thoughts) values ('grande queso burrito', 'amazing');
--Complete Awesome
</code></pre>

<p>Sweet! We&rsquo;re getting the data we want in, it looks legit, and there is no querying of multiple tables to get the values back.
Another benefit to this is that AppDev isn&rsquo;t continually questioning if they set up the FK correctly.</p>

<h4>blowing in the winds of change</h4>

<p>But how maintainble is it? Say we had a less than ideal experience&hellip; one that requires a lawyer.  need to add to our list:</p>

<pre><code>alter type verdict add value 'lawsuit' before 'gross';
insert into burritos (title, thoughts) values ('putrid plate', 'lawsuit');
</code></pre>

<p>That was pretty easy, though I must say I&rsquo;m a little confused on exactly which values I have in my enum. Good thing we&rsquo;re in a database and can just query it!!!:</p>

<pre><code>select t.typname as enum_name,  
       e.enumlabel as enum_value,
       n.nspname as enum_schema
from pg_type t 
   inner join pg_enum e on t.oid = e.enumtypid  
   inner join pg_catalog.pg_namespace n ON n.oid = t.typnamespace
where t.typname = 'verdict' and n.nspname = 'public'
</code></pre>

<h4>re-fear-factor</h4>

<p>If you are ok with the above code&hellip; then good on you. However, we might want to populate a dropdown or something else in our application based on these values. Neither your typical Rails Dev or ActiveRecord itself is going to try to implement the above without tears of saddness streaming down to their Mac. We can build a bridge by just making a simple view and assigning a self.table_name = to the following:</p>

<pre><code>create view my_lovely_enums as 
select t.typname as enum_name,  
       e.enumlabel as enum_value,
       n.nspname as enum_schema 
from pg_type t 
    inner join pg_enum e on t.oid = e.enumtypid  
    inner join pg_catalog.pg_namespace n ON n.oid = t.typnamespace
where t.typname = 'verdict' and n.nspname = 'public';
</code></pre>

<p>Hardcoding &lsquo;verdict&rsquo; like that creates a pretty brittle where clause. I tend to remove that part and go a little more flexible with a predicate/scope to select your enum of choice:</p>

<pre><code>create or replace view my_lovely_enums as 
select t.typname as enum_name,  
       e.enumlabel as enum_value,
       n.nspname as enum_schema
from pg_type t 
    inner join pg_enum e on t.oid = e.enumtypid  
    inner join pg_catalog.pg_namespace n ON n.oid = t.typnamespace;
select * from my_lovely_enums where enum_name = 'verdict' and n.nspname = 'public';
"verdict";"gross";"public"
"verdict";"can eat";"public"
"verdict";"lawsuit";"public"
"verdict";"burrito dreams";"public"
</code></pre>

<p>For some more information on this topic, check out a lovely write up at <a href="http://postgresguide.com/sexy/enums.html">postgresguide.com</a>. The bottom of that article has this handy little  buyer-beware:<br/>
&ldquo;At the time of this writing, Postgres does not provide a way to remove values from enums.&rdquo;
While this approach can&rsquo;t be used for all situations, using it where you can get creates a tremendous amount of simplicity in your app without compromising integrity &ndash; affectionally known as a win-win.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/i-am-a-bad-blogger/">I Am a Bad Blogger</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-06T16:43:00-06:00" pubdate data-updated="true">Jan 6<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I&rsquo;ve never really thought about how bad of a blogger I am. I mean, I always knew deep in my heart I wasn&rsquo;t very good, but a few conversations over the past few months have really solidified just how bad I am. My confession begins.</p>

<h4>Some Person in Somalia has Your Content</h4>

<p>Over the years, I&rsquo;ve seen a lot of emotional breakdowns and anger when someone sees their content reposted on bottom feeder sites. Some people have event pointed out to me when things from this blog appear on there. Each time this has happened, I&rsquo;ve been unable to get angry or motivated enough to try to get it removed. I remember some people like Tom LaRock putting ridiculous
&ldquo;If you are not at thomaslarock.com, this material has been plagiarized by someone who steals content from others.&rdquo; Tynt scripts into his publicly pasted query and just being bewildered by the drama surrounding these episodes. For this lack of sharing without conditions and unwillingness to feign vitriol at a bot, I&rsquo;m a bad blogger.</p>

<h4>Always Be Tweeting</h4>

<p>I don&rsquo;t tweet or retweet my same entry multiple times a day. I blame this partly on the fact
that I&rsquo;m not a consultant nor have the self esteem issues needed to shamelessly market and remarket myself over and over. Another thing I do very poorly is submit a post to Hacker News and then stand on the tweet corner begging for upvotes. Because of this lack of pandering and repetitious pollution, I am a bad blogger.</p>

<h4>Thanks for Writing My Opinion</h4>

<p>me: &lsquo;Your post isn&rsquo;t any different than the press release.&#8217;<br/>
blogger: &ldquo;That is what they told us to say.&#8221;<br/>
To this day, the above conversation has never made sense to me. I&rsquo;m always fascinated by people who do a repost of a marketing piece given to them and then celebrate what a prolific blogger they are. This apathy towards a raw number of blog posts as well as not being an echo chamber for a company on this blog is completely my fault and I apologize.</p>

<h4>A Number of Reasons</h4>

<p>&ldquo;How many readers do you have?&rdquo;, &ldquo;How do you tweak your SEO?&rdquo;, &ldquo;How often do you reblog your most popular post?&rdquo;, &ldquo;What is your peak time of day to release content?&rdquo; and on and on. Barf. Some people think I&rsquo;m just joking when I say I have no idea on the above questions, but it&rsquo;s the truth. More than pretty charts and clicks per minute, I tend to be more inspired by someone just saying &lsquo;hey dude, I checked out that thing on pgbouncer and it worked for me.&rsquo; or being stuck on a smtp configuration in SSRS and searching this site for it. While this does cement that I&rsquo;ll never be an elite blogger, it does let me take acceptance that I&rsquo;m just a bad blogger.</p>

<h4>Truncate Table Opinions</h4>

<p>There are a lot of reasons to blog, and for the most part mine are incredibly selfish. I blog to try to remember things, I blog so I can reference certain posts later&hellip; I blog to help put my thoughts into words and refine an opinion on something. The archive on this site might deceive you, but I tend to &lsquo;blog&rsquo; at least once a week. A great majority of these never get published, but there is something therapeutic and reinforcing about writing something out or laying out a process into steps. If you want to get technical, you could say that I keep a journal that I sometimes publish out of and I wouldn&rsquo;t fight you on it. When you stop caring about others opinions or turning things into a popularity contest, you might be surprised at how easy &ldquo;blogging&rdquo; starts to become and how helpful it get in an industry that doesn&rsquo;t slow down.</p>

<ul>
<li>This was a 10 minute journal entry that I just sort of decided to hit publish on. Goal was to have something to link when I get stuck in these silly conversation.</li>
<li>Followed by 30 minutes or so of fixing typos because I&rsquo;m illiterate.</li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/the-appdevs-are-idiots/">The AppDevs Are Idiots</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-20T23:28:00-06:00" pubdate data-updated="true">Dec 20<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In my many years of Enterprise DBA servitude, there would be many instances of blanket &lsquo;the devs are idiots&rsquo; statements. Sometimes by me, sometimes by others and from the perspective of the database it was usually justifiable. In these enviornments, this is acceptable. I have no idea what busy work task they have come up with and why should I even care about anything out side of my database? These AppsDevs are disgusting dirty creatures that just sling filth everywhere as they stomp their hooves on the keyboard. Worthless.</p>

<h4>Inner Joined at the Hip</h4>

<p>What I enjoy most about the above mindset is the expectation of the AppDev to know their job and be equally proficient at my own. They must be fluent in the language of Stored Procedures else everything collapses from the data hate speech that comes from their object-pooriented programs. I&rsquo;ve often wondered where this one sidedness originated from. For a bit I thought it was just something that happened at places I worked. It&rsquo;s not just there though. Check out your local communities and you&rsquo;ll see the imbalance there as well. I attend both database user groups and developer based user groups. I often see a fair amount of AppDevs at sql events&hellip; I pretty much never see DBAs at developer events.</p>

<h4>Cross Apply What You Know</h4>

<p>A few years back, I got involved in with a few open source .NET ORMs. It goes without saying that ORMs are the <a href="http://www.codinghorror.com/blog/2006/06/object-relational-mapping-is-the-vietnam-of-computer-science.html">Vietnam of the software world</a> and I was pretty much blown away at how desperate these projects were for feedback. It was so easy and fun to help out and it totally changed my opinion of ORMs. It also changed my opinion of the curmudgeoned DBA. If you want some contrast/perspective, I&rsquo;ve also helped out a few &lsquo;open source&rsquo; database projects by their prefered method &ndash; email.</p>

<h4>Refactor the  Query</h4>

<p>The more time you spend with AppDevs the more you realize just how many of them are stuck with really bad DBAs. Now when I hear DBAs complain I ask the following of them:
What open source work do you do?
What dev conferences do you attend with the team?
What have you personally built?
What source control do you use so that the team can see your scripts and ask about them?</p>

<p>You don&rsquo;t have to be Nostradamus to know how the people I&rsquo;m talking about answer the above questions. Like so many things with humans, the loud ones with the most generic argument are typically doing the least to fix the problem. If you are an Oracle/SQL Server DBA, don&rsquo;t just hide behind our industry specific firewalls &ndash; get out there. Engage the AppDevs, review their code, help some project, make your scripts public for them to see. We&rsquo;ve sat in our foxholes long enough and the AppDevs are not our enemy. It&rsquo;s our turn to build the bridge.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/getting-started-with-pgbouncer/">Getting Started With PGBouncer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-12-02T22:00:00-06:00" pubdate data-updated="true">Dec 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the issues we face at Raisemore is a continuous flux in our number of connections to our primary Postgres database. If our load increases and we have to spin up more front end servers or spin up more backend servers. This can quickly wreck our connection limit. One solution, is for me to babysit the connection size on the pg server itself&hellip; or perhaps I can give the Apps the middle finger and starve their connection limit &ndash; neither of these lead to happy outcomes for everyone involved.</p>

<h3>apt-get install happiness</h3>

<p>A better compromise is to just put a connection pooler like <a href="http://wiki.postgresql.org/wiki/PgBouncer">PgBouncer</a> in front of our postgres database. In the same way we proxy our applications with Nginx, we can apply the same concept to our database(s) with Pgbouncer. Let&rsquo;s get started:</p>

<pre><code>--Assuming your pg database is already up and running
--databasename = burrito_hq  username = elguapo
sudo apt-get install -y pgbouncer
sudo nano /etc/pgbouncer/userlist.txt
&gt; "postgres" "postgres"
&gt; "elguapo" "hefe"
sudo nano /etc/pgbouncer/pgbouncer.ini
&gt; [databases]
&gt; burrito_hq = host=localhost port=5432 dbname=burrito_hq user=elguapo password=hefe
&gt; [pgbouncer]
&gt; listen_addr = *
&gt; auth_type = md5
&gt; admin_users = postgres
&gt; stats_users = postgres
</code></pre>

<p>Above are some of the settings I changed to get started. As you get more familiar with Pgbouncer, change the <a href="http://pgbouncer.projects.pgfoundry.org/doc/config.html">various settings</a> as you see fit and for your workload.<br/>
Let&rsquo;s test our settings by firing up PgBouncer. PgBouncer is closely tied to the postgres user on the server, so we&rsquo;ll &lsquo;switch user&rsquo; into the postgres account to crank it up:</p>

<pre><code>sudo su postgres -c"pgbouncer -d /etc/pgbouncer/pgbouncer.ini"
</code></pre>

<p>On our client machine, lets attempt a connection to our server which has an ip of 172.16.150.128:</p>

<pre><code>psql -h 172.16.150.128 -p 6432 -U elguapo -d burrito_hq 
</code></pre>

<p>and hopefully we&rsquo;re in!  Once we know our settings are in good shape, lets turn PgBouncer auto start mode on:</p>

<pre><code>sudo nano /etc/default/pgbouncer
&gt; START=1
sudo reboot #reboot the box to test it out
</code></pre>

<p>When the server comes back online, hopefully you can connect again from the client. Now that the server is stable again, we can go get completely lost in the <a href="http://pgbouncer.projects.pgfoundry.org/doc/usage.html">documentation</a> and let the tool really shine.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/heroku-pg-extras-builds-bridges/">Heroku Pg-extras Builds Bridges</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-20T19:10:00-06:00" pubdate data-updated="true">Nov 20<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It starts with the all too familiar &ldquo;I think my database is running slow&rdquo; and ends with the AppDev and myself speaking different languages, yelling at each and saying hurtful things&hellip; all the while the app and db sit in their servers neglected and needing love.</p>

<h3>pg_therapy</h3>

<p>While many of us that live in the database layer have tricked out <a href="https://github.com/datachomp/dotfiles/blob/master/.psqlrc">.psqlrc</a> files, I rarely find AppDevs with the same. Let me stress that this is perfectly ok!!! But having some really ugly diagnostic queries aliased in your .psqlrc is incredibly helpful. Majority of the AppDevs I talk to concerned about their db also happen to be running on Heroku. To accomodate its users, Heroku has put out a very helpful plugin to their toolbelt called <a href="https://github.com/heroku/heroku-pg-extras">pg-extras</a>. I love this tool because it gets the AppDev and I on a common language. They don&rsquo;t get scared by hairy SQL statement and it&rsquo;s consistent from app to app. Check it out:</p>

<h3>Pump you up</h3>

<p>Installation is a breeze:</p>

<pre><code>heroku plugins:install git://github.com/heroku/heroku-pg-extras.git
</code></pre>

<p>Using it a breeze:</p>

<pre><code>heroku pg:bloat  #one of my favorites!
</code></pre>

<p>When I run that, it tells me that I didn&rsquo;t specify a database:<br/>
! Unknown database. Valid options are: HEROKU_POSTGRESQL_BLACK_URL, HEROKU_POSTGRESQL_PINK_URL</p>

<p>I run it again with the proper db:</p>

<pre><code>heroku pg:bloat HEROKU_POSTGRESQL_BLACK_URL
</code></pre>

<p>Now I have an easy to use snapshot of our database that has an incredibly low barrier of entry to execute for myself or anyone. Let&rsquo;s say that the person running it doesn&rsquo;t trust me or perhaps I&rsquo;m in a burrito coma, they can always refer to the <a href="https://devcenter.heroku.com/articles/heroku-postgres-database-tuning">heroku database tuning site</a> and get sound information.</p>

<h3>Dude, I don&rsquo;t even have time for that.</h3>

<p>Maybe the above is a bit too much to stomach. That&rsquo;s cool, we&rsquo;ll just flip another easy switch:</p>

<pre><code>heroku addons:add librato
</code></pre>

<p><a href="http://librato.com">Librato</a> is a beautiful dashboard that is fun to look at, easy to use and will give us some historical context for troubleshooting the typically ill fated &ldquo;I think my database is slow&rdquo; situation. What is nice about tooling like Librato is not only does it show our db stats, we also get the context of the Application(Dyno&rsquo;s, router latency, etc). For more information on this, checkout Craig Kerstiens post on <a href="https://postgres.heroku.com/blog/past/2013/10/9/monitoring_your_heroku_postgres_database/">Monitoring with Librato</a>.</p>

<h3>Hugs and Queries</h3>

<p>I love this type of solution because it gets us looking at hard numbers and can easily as well as objectively say it is the DBs fault, the Apps fault, heroku&rsquo;s fault, or no ones fault and everything is fine. Librato and Postgres don&rsquo;t keep track of our egos, our mood or our fatigue &ndash; they keep us honest and on topics that really matter&hellip; something we all could use a little more of.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/sequel-and-postgres-range-types/">Sequel and Postgres Range Types</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-15T21:20:00-06:00" pubdate data-updated="true">Nov 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Like many rubyists, I have a hard time keeping up with which burrito truck is parked outside my house on any given day. In postgres, I&rsquo;ve solved this by entering the trucks and the duration they will be staying parked outside in my database:</p>

<pre><code>CREATE TABLE burritotrucks
(
  id serial primary key,
  truckname text not null,
  onsite daterange not null --or tsrange if busy schedule
);

insert into burritotrucks (truckname, onsite)
values ('thumpy tortillas', '[2013-11-15, 2013-11-17]'),
('chompy delight', '[2013-11-15, 2013-11-17]'),
('no dogs allowed', '[2013-11-16, 2013-11-21]'),
('government cheese wagon', '[2013-11-11, 2013-11-14]'),
('tortuga mochilla', '[2013-11-13, 2013-11-18]');
</code></pre>

<p>There are a variety of operators to query <a href="http://www.postgresql.org/docs/current/static/rangetypes.html">range types</a>, but for this example, I&rsquo;ll just be using the <a href="http://www.postgresql.org/docs/current/static/functions-range.html">contains operator</a>:</p>

<pre><code>select * from burritotrucks where onsite @&gt; now()
</code></pre>

<p>Uh oh, it&rsquo;s not working. Unlike the other range types, date ranges require a little more finesse. Postgres doesn&rsquo;t quite trust the implicit conversion so we&rsquo;ll just do a little hand holding:</p>

<pre><code>select * from burritotrucks where onsite @&gt; now()::date
</code></pre>

<p>It works! But how do we do this in our application with <a href="https://github.com/jeremyevans/sequel">Sequel</a>? First, we let <a href="https://github.com/jeremyevans/sequel">Sequel</a> know we&rsquo;re going to be using the range extensions:</p>

<pre><code>Sequel.extension(:pg_range)
DB = Sequel.connect(:adapter=&gt;'postgres', :host=&gt; 'localhost'
, :database=&gt;'frontyard', :user=&gt;'dc')
</code></pre>

<p>We query the database:</p>

<pre><code>options = DB[:burritotrucks].all
p options
</code></pre>

<p>and we get the data. We can see how beautifuly <a href="https://github.com/jeremyevans/sequel">Sequel</a> handles the range type for us in the printed output and at this point we can get away with using our raw sql to get the data we need:</p>

<pre><code>options = DB.fetch("select * from burritotrucks where onsite @&gt; now()::date").all
p options
</code></pre>

<p>This works, but I can imagine many AppDevs becoming ill at the sight of SQL in their app. In order to appease both sides of the aisle, <a href="https://github.com/jeremyevans/sequel">Sequel</a> also has some pretty ruby friendly operators we can use by just adding the core_extensions as well as the range operators extension:</p>

<pre><code>Sequel.extension(:core_extensions, :pg_range, :pg_range_ops)
DB = Sequel.connect(:adapter=&gt;'postgres', :host=&gt; 'localhost'
, :database=&gt;'frontyard', :user=&gt;'dc')
</code></pre>

<p>Now we can get much more ruby friendly queries. Note, We still need to cast for our date value but that is pretty trivial:</p>

<pre><code>options = DB[:burritotrucks].where(:onsite.pg_range.contains(Sequel.cast(Date.today, Date))).all
p options
</code></pre>

<p>People often ask me why I like <a href="https://github.com/jeremyevans/sequel">Sequel</a> so much and this is another great example why. It doesn&rsquo;t punish me for knowing SQL. It doesn&rsquo;t punish postgres for having so many amazing features and data types. It easily lets me know how many burrito trucks I have in my yard which is something you can not put a value on.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/writable-ctes-in-postgres/">Writable CTEs in Postgres</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-15T18:10:00-06:00" pubdate data-updated="true">Nov 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Postgres is filled to the brim with awesome features, but they don&rsquo;t make sense for every occasion. I posted last night about my <a href="http://datachomp.com/archives/my-friend-rob/">Thankyou app</a> and it happens to have a use case for writable <a href="http://www.postgresql.org/docs/current/static/queries-with.html">CTEs (Common Table Expression)</a>.<br/>
First, lets new up some data:</p>

<pre><code>drop table if exists thanks;
create table thanks (
    id serial primary key,
    who text not null,
    picked boolean not null default 'false',
    created_at date default now(),
    last_picked date default '-infinity'
);

insert into thanks (who)
values ('rob conery'), ('postgres'), ('sidekiq'), ('demis bellot'), ('sinatra')
, ('josh berkus'), ('elizabeth naramore'), ('amir rajan'), ('sequel');

select * from thanks;
</code></pre>

<p>Boom! This app selects a random person or project I&rsquo;m thankful for that hasn&rsquo;t already been picked or hasn&rsquo;t been picked in the last 9 months. Here it is in code form:</p>

<pre><code>select * from thanks where picked = false or last_picked &lt; now() - interval '9 months';
</code></pre>

<p>Now we can put it in a normal CTE:</p>

<pre><code>with guesswho as (
    select * from thanks 
    where picked = false or last_picked &lt; now() - interval '9 months')
select guesswho.id, guesswho.who
from guesswho;
</code></pre>

<p>Yes!!! Let&rsquo;s pick a random row. For our randomizer, I would like a lovely set of sequential id&rsquo;s I can pick from. Since we can&rsquo;t completely trust the primary key id&rsquo;s returned in our CTE (especially as rows start to get trimmed off), we&rsquo;re going to throw a row_number function on, as well as pass our first CTE into a second CTE to generate a random number based on the result set:</p>

<pre><code>with guesswho as (
    select ROW_NUMBER() OVER (ORDER BY id) as champs, * 
    from thanks where picked = false or last_picked &lt; now() - interval '9 months')
, onlyone as (select trunc(random() * count(0) + 1) as tops from guesswho)
select guesswho.id, guesswho.who
from guesswho, onlyone
where champs = onlyone.tops;
</code></pre>

<p>Yay!!! We&rsquo;re getting data we love on projects we love. But where does the writable CTE come into play? How cool would it be if we could also mark the record we&rsquo;re selecting as picked, so we don&rsquo;t have to make an additional call to the DB to flag afterwards? Check it out:</p>

<pre><code>with guesswho as (select row_number() over (order by id) as champs, * 
    from thanks where picked = false or last_picked &lt; now() - interval '9 months')
, onlyone as (select trunc(random() * count(0) + 1) as tops from guesswho)

, adios as (update thanks set picked = 'true', last_picked = now() from guesswho, onlyone where thanks.id = guesswho.id and 
guesswho.champs = onlyone.tops RETURNING thanks.picked)

select guesswho.id, guesswho.who
from guesswho, onlyone, adios
where champs = onlyone.tops;
</code></pre>

<p>So.Much.Awesome! Check out that 3rd CTE we added (adios), is using our previous CTE&rsquo;s, updating the row we chose, as well as providing a returning statement of what it updated. The returning statement provides context for what happened inside that writable CTE to alleviate confusion between table expresisons. Feel free to play with it on your own machine and especially change the data for the people or tech you&rsquo;re thankful for.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/my-friend-rob/">My Friend Rob</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-14T22:05:00-06:00" pubdate data-updated="true">Nov 14<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>It&rsquo;s been a little over 6 months since I left .Net and one of the personal concerns I had with Postgres/Ruby was how long it would be before I started getting complacent and taking everything for granted.</p>

<h3>Always Be Coding</h3>

<p>To counteract this concern, I made a little database full of projects and people I&rsquo;m thankful for. You&rsquo;ll see projects like sidekiq, hstore, pg_stat_statements, sinatra and you&rsquo;ll also see people like Josh Berkus, Ryan Bates, Demis Bellot… It&rsquo;s become a pretty big table because I&rsquo;m thankful to so many. I also made a little console app to pick a random row and email it to me once a week because what good is data if you don&rsquo;t use it?</p>

<h3>It Passes in a Flash</h3>

<p>The past few months have been amazing. The team I work with at Raisemore is top notch and it is an incredible feeling to be working with and helping non-profits every day. Tekpub got acquired by Pluralsight. That experience has been a lot of work and an absolute blast building videos with them. I&rsquo;ve also helped reboot our local Ruby user group with 2 other friends and spoke to that group today on two topics I absolutely love &ndash; Sequel and Postgres.</p>

<h3>For Whom The Phone Tolls</h3>

<p>We just got back from dinner and I&rsquo;m checking my usual blog posts and nightly reading when I get the familiar email every Friday at 00:00:00 UTC:<br/>
Subject: Be Thankful<br/>
Body: 1 &ndash; Rob Conery</p>

<p>I don&rsquo;t know if it gets anymore serendipitous than that. Rob is the first entry I put in the table. Since I&rsquo;ve met Rob, he has challenged me to be a better DBA, challenged my comfort zones and to be an overall better person. Some of the above he&rsquo;s done directly, some of it indirectly and I&rsquo;m thankful for all if it.</p>

<h3>perspective.empty?</h3>

<p>I can&rsquo;t wait to see who/what shows up in my inbox next week. I can&rsquo;t wait to reflect on what is was that connected with me. When I get the next mail, I don&rsquo;t know yet if I&rsquo;ll take the time to personally thank them or the project. What I do know is that between now and when I get my next mail, I hope that I can have the same effect on others my list has had on me.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/helping-asset-pipeline-open-up-a-little/">Helping Asset Pipeline Open Up a Little</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-26T14:42:00-05:00" pubdate data-updated="true">Oct 26<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A working Asset Pipeline can be a thing of beauty. A broken asset pipeline can be a horribly mean shut-in. One of my favorite ways for it to break in my Rails 3 app is the:</p>

<pre><code>undefined method `directory?' for nil:NilClass
rake aborted
</code></pre>

<p>Thanks AP, for breaking and basically telling me nothing. Luckily, it doesn&rsquo;t have to be this way. If we take a moment to stop and get to know AP, we can get it to open up and be more helpful to us. We start by setting our bundler editor in .bashrc by adding the following line:</p>

<pre><code>export BUNDLER_EDITOR=subl   #I set mine to sublimetext
</code></pre>

<p>Next up, we hop into terminal and go for an in home visit right into the code itself:</p>

<pre><code>bundle open sprockets  #sprockets is AP's birth name
</code></pre>

<p>Navigate to lib->sprockets->base.rb</p>

<p>find your way to the &ldquo;def each_entry(root, &amp;block)&rdquo; section of code and you&rsquo;ll likely see a lack of error handling there. To fix it, I wrap a rescue around the &ldquo;directory?&rdquo; check like so:</p>

<pre><code>begin
    if stat(path).directory?
      each_entry(path) do |subpath|
        paths &lt;&lt; subpath
      end
    end
    rescue
      puts "Hey friend, I have an issue at: #{path}"
    end
end
</code></pre>

<p>This doesn&rsquo;t fix all of AP&rsquo;s problems, none of us are perfect, but it does coax the gem into letting us know where the problem is. Once we know where the problem is, we can work on it together rather than just throwing our arms up in the air and quitting.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/archives/radius-queries-in-postgres/">Radius Queries in Postgres</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-07T13:56:00-05:00" pubdate data-updated="true">Oct 7<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today, I found myself in a horrible situation. I was heading down i-235 and I became stricken with an insatiable burrito urge. All the apps on my phone were borked and all I had was my trusty Postgres database. I needed to find a burritos shop and I needed to find one fast.</p>

<h4>Where oh where to begin</h4>

<p>Luckily, I happen to know the latitude and longitude of all my favorite burrito places in Oklahoma City. I quickly add them to my database:</p>

<pre><code>--Hello Table!
CREATE TABLE burritoplaces
(id serial PRIMARY KEY,
establishment varchar(50) not null,
lat double precision,
lon double precision);  
--Hello Data!
INSERT INTO burritoplaces(establishment, lat,lon)
VALUES ('Verde Bueno Burrito', 35.484388,-97.505035)
,('Locos Lobos', 35.496025,-97.510185)
,('Captain Crustacean', 35.51468,-97.524347)
,('Double Stuffers Cafe', 35.523762,-97.508039)
,('Cafe Truncate of Watonga', 35.866413,-98.473206);
</code></pre>

<p>The data checks out:</p>

<pre><code>-- all 5 entries
SELECT * FROM burritoplaces;
</code></pre>

<p>Perfect! All my favorite places are there but sadly, I can&rsquo;t do geospatial math in my head. I can&rsquo;t even really do it outside of my head so I&rsquo;m going to have to get some help. Enter the <a href="http://www.postgresql.org/docs/current/static/earthdistance.html">earthdistance</a> postgres extension and its helpful sibling &lsquo;cube&rsquo;:</p>

<pre><code>--turn on the magic
CREATE EXTENSION cube;
CREATE EXTENSION earthdistance;
</code></pre>

<p>I&rsquo;m becoming so weak&hellip; I need to wrap this up. Since I live in one of the four countries in the world that uses the Imperial system of measurement, I need to figure out how to do this whole thing in miles. Skimming over the earthdistance documentation, it looks like I just need to use the point commands. I whip up a query that is as tech tasty as some carne asada:</p>

<pre><code>-- my location on i-235 is a very hungry (35.512363,-97.515678)
SELECT *, point(-97.515678, 35.512363) &lt;@&gt; point(lon, lat)::point AS burrito_distance
FROM burritoplaces
WHERE (point(-97.515678, 35.512363) &lt;@&gt; point(lon, lat)) &lt; 10 --feel free to play this!
ORDER by burrito_distance;
</code></pre>

<p>This returns me everything that is less than 10 miles away and orders them by distance. I see that Captain Crustacian is a half mile away and they have amazing guacamole. Thank you Postgres, cube, and earthdistance. You have saved my life once again.</p>

<p>If I lived anywhere else in the world, I would likely use meters and write the query as such:</p>

<pre><code>SELECT *, earth_distance(ll_to_earth(35.512363,-97.515678), ll_to_earth(lat, lon)) as burrito_distance
FROM burritoplaces
WHERE earth_box(ll_to_earth(35.512363,-97.515678), 4000) @&gt; ll_to_earth(lat, lon)
ORDER by burrito_distance;
</code></pre>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
	<a href="/"><img src="http://static.datachomp.com/datachomp.png" width="236" height="236" alt="Data Eating Alligator" /></a><br/>
	<a href="http://tekpub.com/collections/everything/products/pg"><img src="http://static.datachomp.com/pg_thumb.png" alt="Tekpub" width=120 height=80 /></a>
	<br/>
	<a href="http://tekpub.com/collections/everything/products/ft_sullivan"><img src="http://static.datachomp.com/ft_sullivan_thumb.png" alt="Tekpub" /></a>	
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/archives/enums-for-when-you-just-cant-hande-another-foreign-key/">Enums for When You Just Cant Hande Another Foreign Key</a>
      </li>
    
      <li class="post">
        <a href="/archives/i-am-a-bad-blogger/">I Am a Bad Blogger</a>
      </li>
    
      <li class="post">
        <a href="/archives/the-appdevs-are-idiots/">The AppDevs Are Idiots</a>
      </li>
    
      <li class="post">
        <a href="/archives/getting-started-with-pgbouncer/">Getting Started With PGBouncer</a>
      </li>
    
      <li class="post">
        <a href="/archives/heroku-pg-extras-builds-bridges/">Heroku Pg-extras Builds Bridges</a>
      </li>
    
  </ul>
</section>





  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Rob Sullivan - Hand-crafted in OK <img src="http://static.datachomp.com/ok.gif" height="15" width="15" /> - 
  <span class="credit">Served by <a href="http://octopress.org">Octopress</a> and Github</span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'datachomp';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
